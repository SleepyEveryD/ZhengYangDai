//Project/backend/prisma/schema.prisma
datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

generator client {
  provider = "prisma-client-js"
}

enum RideStatus {
  DRAFT
  CONFIRMED
}

enum RoadCondition {
  EXCELLENT
  GOOD
  FAIR
  NEED_REPAIR
}

enum IssueType {
  NONE
  POTHOLE
  BUMP
  GRAVEL
  CONSTRUCTION
  OTHER
}
model Ride {
  id               String      @id @default(uuid())
  userId           String

  routeGeometry    Unsupported("geography(LineString, 4326)")

  totalDistanceM   Float
  totalDurationS   Int
  avgSpeedKmh      Float
  maxSpeedKmh      Float

  status           RideStatus  @default(DRAFT)

  startedAt        DateTime
  endedAt          DateTime
  createdAt        DateTime    @default(now())

  // relations
  segments         RideSegment[]

  @@index([userId])
}
model RideSegment {
  id           String   @id @default(uuid())
  rideId       String
  orderIndex   Int

  geometry     Unsupported("geography(LineString, 4326)")
  lengthM      Float

  createdAt   DateTime @default(now())

  // relations
  ride         Ride    @relation(fields: [rideId], references: [id], onDelete: Cascade)
  report       RideSegmentReport?

  @@index([rideId])
  @@unique([rideId, orderIndex])
}
model RideSegmentReport {
  id              String        @id @default(uuid())
  rideSegmentId   String        @unique

  roadCondition   RoadCondition
  issueType       IssueType     @default(NONE)
  notes           String?

  createdAt       DateTime      @default(now())

  // relations
  rideSegment     RideSegment   @relation(fields: [rideSegmentId], references: [id], onDelete: Cascade)
}
model PathSegment {
  id           String   @id @default(uuid())
  geometry     Unsupported("geography(LineString, 4326)")
  lengthM      Float

  createdAt    DateTime @default(now())

  // relations
  aggregated   AggregatedSegment?
}
model AggregatedSegment {
  segmentId       String   @id
  finalCondition  RoadCondition
  agreementScore  Float
  obstacleSummary Json?

  lastUpdatedAt   DateTime @updatedAt

  // relations
  segment         PathSegment @relation(fields: [segmentId], references: [id], onDelete: Cascade)
}