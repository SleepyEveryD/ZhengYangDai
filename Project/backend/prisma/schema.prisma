datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
  directUrl  = env("DIRECT_URL")
}


generator client {
  provider = "prisma-client-js"
}

enum RideStatus {
  DRAFT
  CONFIRMED
}

enum RoadCondition {
  EXCELLENT
  GOOD
  FAIR
  NEED_REPAIR
}

enum IssueType {
  NONE
  POTHOLE
  BUMP
  GRAVEL
  CONSTRUCTION
  OTHER
}

model Ride {
  id             String      @id @default(uuid())
  userId         String
  routeGeoJson   Json?
  routeGeometry  Unsupported("geography(LineString, 4326)")?
  status         RideStatus  @default(DRAFT)
  startedAt      DateTime
  endedAt        DateTime
  createdAt      DateTime    @default(now())
  issues         StreetIssue[]
  reports        StreetReport[]
  weather        RideWeather?

  
  @@index([userId])
}

model Street {
  id           String              @id @default(uuid())
  externalId   String              @unique
  name         String?
  city         String?
  country      String?
  geometryJson Json?
  geometry     Unsupported("geography(LineString, 4326)")?
  createdAt    DateTime            @default(now())
  reports      StreetReport[]
  aggregation  StreetAggregation?
  
  @@index([name])
  @@index([city, name])
}

model StreetIssue {
  id           String      @id @default(uuid())
  userId       String
  rideId       String
  issueType    IssueType
  locationJson Json?
  location     Unsupported("geography(Point, 4326)")?
  notes        String?
  createdAt    DateTime    @default(now())
  ride         Ride        @relation(fields: [rideId], references: [id], onDelete: Cascade)
  
  @@index([rideId])
  @@index([userId])
  @@index([issueType])
}

model StreetReport {
  id            String        @id @default(uuid())
  userId        String
  rideId        String
  streetId      String
  roadCondition RoadCondition
  notes         String?
  createdAt     DateTime      @default(now())

  ride          Ride          @relation(fields: [rideId], references: [id], onDelete: Cascade)
  street        Street        @relation(fields: [streetId], references: [id], onDelete: Cascade)

  @@unique([userId, rideId, streetId], name: "user_ride_street_unique")
  @@index([streetId])
  @@index([rideId])
  @@index([userId])
}


model StreetAggregation {
  streetId       String        @id
  finalCondition RoadCondition
  agreementScore Float
  issueSummary   Json?
  lastUpdatedAt  DateTime      @updatedAt
  street         Street        @relation(fields: [streetId], references: [id], onDelete: Cascade)
}
model RideWeather {
  id        String   @id @default(uuid())
  rideId    String   @unique

  temp      Int?
  condition String?
  wind      String?

  raw       Json?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  ride      Ride     @relation(fields: [rideId], references: [id], onDelete: Cascade)
}